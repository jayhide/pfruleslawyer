This is a repo that serves two purposes:
1) To scrape pathfinder 1e rules and content from the https://www.d20pfsrd.com/ website
2) To use RAG over the scraped rules to provide relevant context to an llm which answers questions on pathfinder 1e rules

poetry is used to track dependencies and maintain the environment for running code

## Project Structure

- `rules/` - Scraped markdown files from d20pfsrd.com
- `manifests/` - Section manifests (JSON) generated by preprocessing
- `url_to_markdown.py` - Scrapes a URL and converts to markdown
- `chunking_prompt.py` - Prompt template for LLM-powered section extraction
- `preprocess_sections.py` - Generates section manifests from markdown files
- `section_extractor.py` - Extracts section content using manifests
- `vector_store.py` - ChromaDB vector store for semantic search
- `vectordb/` - Persisted vector database
- `rules_lawyer.py` - RAG-powered rules Q&A interface

## Section Preprocessing

The markdown files have inconsistent heading structures, so we use an LLM to identify logical sections for RAG retrieval.

### Usage

```bash
# Process all rules files
poetry run python preprocess_sections.py -v

# Process a single file
poetry run python preprocess_sections.py --file combat.md -v
```

### Output Format

Each manifest in `manifests/` contains sections with:
- `id` - Unique identifier
- `title` - Human-readable name
- `anchor_heading` - Exact markdown heading to locate the section
- `includes_subheadings` - Subheadings contained in this section
- `description` - Brief summary of the rules covered
- `keywords` - Terms for retrieval matching

## Section Extraction

Use `SectionExtractor` to load and search sections:

```python
from section_extractor import SectionExtractor

extractor = SectionExtractor()
sections = extractor.load_all_sections()  # 301 sections

# Search by text (matches title, description, keywords)
results = extractor.search_by_text("grapple")

# Get specific section by ID
section = extractor.get_section_by_id("flat_footed_condition")
print(section.content)  # Full markdown content
```

Each `Section` object has: `id`, `title`, `description`, `keywords`, `content`, `source_file`, `anchor_heading`

## Vector Search (RAG)

Build and query the semantic search index:

```bash
# Build/rebuild the index
poetry run python vector_store.py --build

# Query for relevant sections
poetry run python vector_store.py -q "how does grappling work"
poetry run python vector_store.py -q "attack of opportunity" -n 10
```

Or use programmatically:

```python
from vector_store import RulesVectorStore

store = RulesVectorStore()
results = store.query("what happens when I fall unconscious", n_results=5)

for r in results:
    print(f"{r['title']} (score: {r['score']:.3f})")
    print(r['content'])
```

## Asking Rules Questions

The main interface for asking Pathfinder rules questions:

```bash
# Single question
poetry run python rules_lawyer.py "How does grappling work?"

# With verbose output (shows retrieved sections)
poetry run python rules_lawyer.py "What is flat-footed?" -v

# Interactive mode
poetry run python rules_lawyer.py
```

The system retrieves the top 5 most relevant rules sections and uses Claude to answer based on those rules.

## Environment

Requires `ANTHROPIC_API_KEY` in `.env` file.
